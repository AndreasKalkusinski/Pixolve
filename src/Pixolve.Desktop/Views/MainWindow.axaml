<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:Pixolve.Desktop.ViewModels"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:converters="using:Pixolve.Desktop.Converters"
        mc:Ignorable="d" d:DesignWidth="900" d:DesignHeight="650"
        x:Class="Pixolve.Desktop.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/pixolve-logo.ico"
        Title="Pixolve - Moderner Bild-Konverter"
        Width="900" Height="650"
        MinWidth="800" MinHeight="600"
        DragDrop.AllowDrop="True">

    <Window.Resources>
        <converters:ByteArrayToImageConverter x:Key="ByteArrayToImageConverter"/>
    </Window.Resources>

    <Design.DataContext>
        <!-- This only sets the DataContext for the previewer in an IDE,
             to set the actual DataContext for runtime, set the DataContext property in code (look at App.axaml.cs) -->
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="{Binding Localization.AppTitle}" FontSize="28" FontWeight="Bold"/>
            <TextBlock Text="{Binding Localization.AppSubtitle}" FontSize="14" Opacity="0.7"/>
        </StackPanel>

        <!-- Source Selection & Settings -->
        <Grid Grid.Row="1" Margin="0,0,0,16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Source Path -->
            <Border Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="2"
                    BorderBrush="{DynamicResource SystemAccentColor}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="12"
                    Margin="0,0,0,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="{Binding Localization.SourceFolder}" VerticalAlignment="Center" Margin="0,0,12,0"/>
                    <TextBox Grid.Column="1" Text="{Binding SourcePath}" Watermark="{Binding Localization.SourceFolderPlaceholder}" VerticalAlignment="Center"/>
                    <Button Grid.Column="2" Content="{Binding Localization.Browse}" Command="{Binding BrowseFolderCommand}" Margin="8,0,0,0" Padding="16,8"/>
                    <Button Grid.Column="3" Content="{Binding Localization.LoadImages}" Command="{Binding LoadImagesCommand}" Margin="8,0,0,0" Padding="16,8" IsEnabled="{Binding !IsLoading}"/>
                </Grid>
            </Border>

            <!-- Settings Panel - Responsive Grid Layout -->
            <Border Grid.Row="1" Grid.Column="0"
                    BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="12"
                    Margin="0,0,8,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" MinWidth="160"/>
                        <ColumnDefinition Width="*" MinWidth="160"/>
                        <ColumnDefinition Width="*" MinWidth="140"/>
                        <ColumnDefinition Width="*" MinWidth="140"/>
                    </Grid.ColumnDefinitions>

                    <!-- Format & Qualität -->
                    <StackPanel Grid.Row="0" Grid.Column="0" Margin="0,0,12,0">
                        <TextBlock Text="{Binding Localization.FormatAndQuality}" FontSize="10" FontWeight="Bold" Opacity="0.6" Margin="0,0,0,8"/>

                        <TextBlock Text="{Binding Localization.Format}" FontSize="11" Margin="0,0,0,4"/>
                        <ComboBox ItemsSource="{Binding AvailableFormats}"
                                  SelectedItem="{Binding SelectedFormatOption}"
                                  FontSize="11"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayName}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <TextBlock Text="{Binding Localization.Quality}" FontSize="11" Margin="0,0,0,4"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="35"/>
                            </Grid.ColumnDefinitions>
                            <Slider Grid.Column="0" Minimum="0" Maximum="100" Value="{Binding Quality}" TickFrequency="5" IsSnapToTickEnabled="True"/>
                            <TextBlock Grid.Column="1" Text="{Binding Quality}" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="11"/>
                        </Grid>
                    </StackPanel>

                    <!-- Größe & Ausgabe -->
                    <StackPanel Grid.Row="0" Grid.Column="1" Margin="0,0,12,0">
                        <TextBlock Text="{Binding Localization.SizeAndOutput}" FontSize="10" FontWeight="Bold" Opacity="0.6" Margin="0,0,0,8"/>

                        <TextBlock Text="{Binding Localization.MaxPixel}" FontSize="11" Margin="0,0,0,4"/>
                        <Grid Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="35"/>
                            </Grid.ColumnDefinitions>
                            <Slider Grid.Column="0" Minimum="512" Maximum="4096" Value="{Binding MaxPixelSize}" TickFrequency="256" IsSnapToTickEnabled="True"/>
                            <TextBlock Grid.Column="1" Text="{Binding MaxPixelSize}" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="11"/>
                        </Grid>

                        <TextBlock Text="{Binding Localization.OutputDirectory}" FontSize="11" Margin="0,0,0,4"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox Grid.Column="0" Text="{Binding OutputDirectory}" Watermark="{Binding Localization.OutputDirectoryWatermark}" FontSize="11" Margin="0,0,4,0"/>
                            <Button Grid.Column="1" Content="..." Command="{Binding BrowseOutputFolderCommand}" Width="30" Padding="4"/>
                        </Grid>
                    </StackPanel>

                    <!-- Optionen -->
                    <StackPanel Grid.Row="0" Grid.Column="2" Margin="0,0,12,0">
                        <TextBlock Text="{Binding Localization.Options}" FontSize="10" FontWeight="Bold" Opacity="0.6" Margin="0,0,0,8"/>
                        <CheckBox IsChecked="{Binding EnableResizing}" Content="{Binding Localization.EnableResizing}" FontSize="11" Margin="0,0,0,4"/>
                        <CheckBox IsChecked="{Binding OverwriteExisting}" Content="{Binding Localization.OverwriteExisting}" FontSize="11" Margin="0,0,0,4"/>
                        <CheckBox IsChecked="{Binding PreserveTimestamp}" Content="{Binding Localization.PreserveTimestamp}" FontSize="11" Margin="0,0,0,4"/>
                        <CheckBox IsChecked="{Binding IncludeSubfolders}" Content="{Binding Localization.IncludeSubfolders}" FontSize="11"/>
                    </StackPanel>

                    <!-- Darstellung -->
                    <StackPanel Grid.Row="0" Grid.Column="3">
                        <TextBlock Text="{Binding Localization.Appearance}" FontSize="10" FontWeight="Bold" Opacity="0.6" Margin="0,0,0,8"/>

                        <TextBlock Text="{Binding Localization.Theme}" FontSize="11" Margin="0,0,0,4"/>
                        <ComboBox ItemsSource="{Binding AvailableThemes}"
                                  SelectedItem="{Binding SelectedThemeOption}"
                                  FontSize="11"
                                  HorizontalAlignment="Stretch"
                                  Margin="0,0,0,8">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayName}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <TextBlock Text="{Binding Localization.Language}" FontSize="11" Margin="0,0,0,4"/>
                        <ComboBox ItemsSource="{Binding AvailableLanguages}"
                                  SelectedItem="{Binding SelectedLanguageOption}"
                                  FontSize="11"
                                  HorizontalAlignment="Stretch">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DisplayName}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>

                    <!-- Multi-Format Export -->
                    <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4" Margin="0,12,0,0">
                        <Separator Margin="0,0,0,12"/>
                        <CheckBox IsChecked="{Binding EnableMultiFormat}"
                                  Content="{Binding Localization.MultiFormatExport}"
                                  FontWeight="Bold"
                                  FontSize="11"
                                  Margin="0,0,0,8"/>

                        <ItemsControl ItemsSource="{Binding MultiFormatOptions}"
                                      IsVisible="{Binding EnableMultiFormat}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Margin="0,0,20,0" Width="120">
                                        <CheckBox IsChecked="{Binding IsSelected}"
                                                  Content="{Binding DisplayName}"
                                                  FontSize="11"
                                                  Margin="0,0,0,4"/>
                                        <TextBox Text="{Binding CustomQuality}"
                                                 Watermark="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.QualityWatermark}"
                                                 FontSize="10"
                                                 IsVisible="{Binding IsSelected}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Action Buttons -->
            <Border Grid.Row="1" Grid.Column="1"
                    BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                    BorderThickness="1"
                    CornerRadius="4"
                    Padding="12"
                    Width="200">
                <StackPanel Spacing="8">
                    <TextBlock Text="{Binding Localization.Actions}" FontWeight="Bold" Margin="0,0,0,4"/>
                    <Button Content="{Binding Localization.ConvertAll}" Command="{Binding ConvertImagesCommand}" HorizontalAlignment="Stretch" Padding="12,8" IsEnabled="{Binding !IsConverting}"/>
                    <Button Content="{Binding Localization.Cancel}" Command="{Binding CancelConversionCommand}" HorizontalAlignment="Stretch" Padding="12,8" IsEnabled="{Binding IsConverting}"/>
                    <Button Content="{Binding Localization.ClearList}" Command="{Binding ClearImagesCommand}" HorizontalAlignment="Stretch" Padding="12,8" IsEnabled="{Binding !IsConverting}"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- Image List DataGrid -->
        <Border Grid.Row="2"
                BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                BorderThickness="1"
                CornerRadius="4"
                Margin="0,0,0,12">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Disabled">
                <DataGrid ItemsSource="{Binding ImageFiles}"
                          AutoGenerateColumns="False"
                          GridLinesVisibility="All"
                          IsReadOnly="True"
                          CanUserResizeColumns="True"
                          CanUserSortColumns="True"
                          RowHeight="60"
                          HorizontalScrollBarVisibility="Disabled"
                          VerticalScrollBarVisibility="Auto">
                <DataGrid.Columns>
                    <DataGridTemplateColumn Header="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Preview}" Width="Auto" MinWidth="70">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Image Source="{Binding ThumbnailData, Converter={StaticResource ByteArrayToImageConverter}}"
                                       Width="50" Height="50"
                                       Stretch="Uniform"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.FileName}" Binding="{Binding FileName}" Width="Auto" MinWidth="150"/>
                    <DataGridTextColumn Header="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Status}" Binding="{Binding Status}" Width="Auto" MinWidth="120"/>
                    <DataGridTextColumn Header="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Before}" Binding="{Binding FileSizeBeforeFormatted}" Width="Auto" MinWidth="80"/>
                    <DataGridTextColumn Header="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.After}" Binding="{Binding FileSizeAfterFormatted}" Width="Auto" MinWidth="80"/>
                    <DataGridTextColumn Header="%" Binding="{Binding CompressionRatioFormatted}" Width="Auto" MinWidth="60"/>
                    <DataGridTextColumn Header="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Pixel}" Binding="{Binding PixelSizeBefore}" Width="Auto" MinWidth="100"/>
                    <DataGridTemplateColumn Header="⚙" Width="50">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="⚙"
                                        Padding="8,4"
                                        FontSize="14"
                                        HorizontalContentAlignment="Center"
                                        ToolTip.Tip="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.CustomSettings}">
                                    <Button.Flyout>
                                        <Flyout Placement="Bottom">
                                            <StackPanel Width="250" Spacing="8">
                                                <TextBlock Text="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.CustomSettings}" FontWeight="Bold" Margin="0,0,0,8"/>

                                                <TextBlock Text="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.FormatEmptyGlobal}" FontSize="11"/>
                                                <ComboBox SelectedIndex="{Binding CustomTargetFormat}" FontSize="11">
                                                    <ComboBoxItem Content="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Global}"/>
                                                    <ComboBoxItem Content="WebP"/>
                                                    <ComboBoxItem Content="PNG"/>
                                                    <ComboBoxItem Content="JPEG"/>
                                                    <ComboBoxItem Content="AVIF"/>
                                                </ComboBox>

                                                <TextBlock Text="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.QualityEmptyGlobal}" FontSize="11" Margin="0,4,0,0"/>
                                                <TextBox Text="{Binding CustomQuality}" Watermark="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Global}" FontSize="11"/>

                                                <TextBlock Text="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.MaxPixelEmptyGlobal}" FontSize="11" Margin="0,4,0,0"/>
                                                <TextBox Text="{Binding CustomMaxPixelSize}" Watermark="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.Global}" FontSize="11"/>

                                                <TextBlock Text="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).Localization.CustomSettingsNote}"
                                                           FontSize="10"
                                                           Opacity="0.7"
                                                           TextWrapping="Wrap"
                                                           Margin="0,8,0,0"/>
                                            </StackPanel>
                                        </Flyout>
                                    </Button.Flyout>
                                </Button>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTemplateColumn Header="" Width="50">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <Button Content="✕"
                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).RemoveImageCommand}"
                                        CommandParameter="{Binding}"
                                        Padding="8,4"
                                        FontSize="16"
                                        FontWeight="Bold"
                                        HorizontalContentAlignment="Center"
                                        ToolTip.Tip="Entfernen"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
                </DataGrid>
            </ScrollViewer>
        </Border>

        <!-- Progress Bar -->
        <StackPanel Grid.Row="3" Margin="0,0,0,8">
            <ProgressBar Minimum="0"
                         Maximum="{Binding ProgressMaximum}"
                         Value="{Binding ProgressValue}"
                         Height="8"
                         ShowProgressText="False"
                         IsVisible="{Binding IsLoading}"/>
            <ProgressBar Height="8"
                         IsIndeterminate="True"
                         ShowProgressText="False"
                         IsVisible="{Binding IsConverting}"/>
        </StackPanel>

        <!-- Status Bar -->
        <Border Grid.Row="4"
                Background="{DynamicResource SystemControlBackgroundAltMediumBrush}"
                CornerRadius="4"
                Padding="12,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0" Text="{Binding Localization.StatusLabel}" FontWeight="Bold" Margin="0,0,8,0"/>
                <TextBlock Grid.Column="1" Text="{Binding StatusMessage}"/>
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="{Binding Localization.ImagesCount}" FontWeight="Bold" Margin="0,0,4,0"/>
                    <TextBlock Text="{Binding ImageFiles.Count}" FontWeight="Bold"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
